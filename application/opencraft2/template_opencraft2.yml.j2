apiVersion: v1
kind: Pod
metadata:
  name: {{ app_name }}-%ITEM
  labels:
    app.kubernetes.io/name: {{ app_name }}-%ITEM
    applicationRunning: 'opencraft2'
spec:
  restartPolicy: Never # important so that server can be stopped without making K8 recreate the pod
  hostNetwork: true
  containers:
  - name: {{ app_name }}
    image: {{ image }}
    ports:
      - containerPort: 7979
        name: game-port
        protocol: UDP
      - containerPort: 7980
        name: deployment-port
        protocol: UDP
    imagePullPolicy: Always
    volumeMounts:
    - mountPath: /opencraft2/logs
      name: logs-volume
    resources:
      requests:
        memory: "{{ memory_req }}Mi"
        cpu: {{ cpu_req }}
    command: ["./opencraft2.x86_64", "-playType", "Server", "-nographics", "-batchmode", "-localConfigJson","./localconfig.json","-logFile", "./logs/opencraft2_log.txt", "-profiler-enable", "-profiler-log-file", "./logs/profiler_out.raw", "-duration", "{{ experiment_duration }}"]
  volumes:
  - name: logs-volume
    hostPath:
      # directory location on host
      path: /logs
      type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: {{ app_name }}-service-%ITEM
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: {{ app_name }}-%ITEM
  ports:
  - name: server-service-port
    port: 7979
    nodePort: 30079
    protocol: UDP
    targetPort: game-port
  - name: deployment-service-port
    port: 7980
    nodePort: 30080
    protocol: UDP
    targetPort: deployment-port